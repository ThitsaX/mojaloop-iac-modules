apiVersion: redhatcop.redhat.io/v1alpha1
kind: PasswordPolicy
metadata:
  name: praefectdb-password-policy
  namespace: ${ARGOCD_ENV_vault_namespace}
spec:
  # Add fields here
  authentication:
    path: ${ARGOCD_ENV_vault_k8s_admin_auth_path}
    role: ${ARGOCD_ENV_vault_k8s_admin_role_name}
    serviceAccount:
      name: default
  passwordPolicy: |
    length = 20
      rule "charset" {
        charset = "abcdefghijklmnopqrstuvwxyz"
        min-chars = 1
      }
      rule "charset" {
        charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
        min-chars = 1
      }
      rule "charset" {
        charset = "0123456789"
        min-chars = 1
      }
      rule "charset" {
        charset = "_"
        min-chars = 1
      }
---
apiVersion: redhatcop.redhat.io/v1alpha1
kind: RandomSecret
metadata:
  name: praefectdb-password
  namespace: ${ARGOCD_ENV_vault_namespace}
spec:
  authentication:
    path: ${ARGOCD_ENV_vault_k8s_admin_auth_path}
    role: ${ARGOCD_ENV_vault_k8s_admin_role_name}
    serviceAccount:
      name: default
  isKVSecretsEngineV2: true
  path: /secret/data/praefectdb
  secretKey: password
  secretFormat:
    passwordPolicyName: praefectdb-password-policy
---
apiVersion: redhatcop.redhat.io/v1alpha1
kind: VaultSecret
metadata:
  name: gitlab-praefectdb-secret
  namespace: ${ARGOCD_ENV_vault_namespace}
spec:
  refreshPeriod: 1m0s
  vaultSecretDefinitions:
    - authentication:
        path: ${ARGOCD_ENV_vault_k8s_admin_auth_path}
        role: ${ARGOCD_ENV_vault_k8s_admin_role_name}
        serviceAccount:
          name: default
      name: dynamicsecret_praefectdb_password
      path: /secret/data/praefectdb/praefectdb-password
  output:
    name: gitlab-praefectdb-secret
    stringData:
      password: "{{ .dynamicsecret_praefectdb_password.password }}"
    type: Opaque
    annotations:
      reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
      reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: "${ARGOCD_ENV_gitlab_namespace}"
      reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true" # Auto create reflection for matching namespaces
      reflector.v1.k8s.emberstack.com/reflection-auto-namespaces: "${ARGOCD_ENV_gitlab_namespace}"

---
apiVersion: infitx.org/v1alpha1
kind: DBInstanceClaim
metadata:
  name: praefectdb
  namespace: "${ARGOCD_ENV_gitlab_namespace}"
  annotations:
    organization: Infitx
    author: devops
spec:
  id: praefectdb
  compositionSelector:
    matchLabels:
      provider: aws
      db: postgresql
  parameters:
    region: ${ARGOCD_ENV_cloud_region}
    engineVersion: "16"
    size: small
    storageGB: ${ARGOCD_ENV_rds_praefect_postgres_storage_size}
    subnets: ${ARGOCD_ENV_rds_subnet_list}
    databaseName: praefect
    userName: praefect
    passwordSecret:
      key: password
      name: praefect-postgresql-credentials    